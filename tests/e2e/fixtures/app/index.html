<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>Reservation Widget (Fixture)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    body { margin: 24px; }
    .row { display: grid; grid-template-columns: 160px 1fr; gap: 8px; align-items: center; margin: 8px 0; }
    .grid { display: grid; grid-template-columns: repeat(3, minmax(120px, 1fr)); gap: 8px; margin: 8px 0; }
    button { padding: 8px 12px; cursor: pointer; }
    input { padding: 6px 8px; width: 220px; }
    .muted { color: #666; }
    .hidden { display: none !important; }
    .ok { color: #0a7f3f; font-weight: 600; }
    .err { color: #b00020; font-weight: 600; }
    .card { border: 1px solid #ddd; border-radius: 8px; padding: 16px; margin: 12px 0; }
    /* 視覚的に選択状態が分かるよう軽く装飾 */
    .selected { outline: 2px solid #0a7f3f; border-radius: 6px; }
  </style>
</head>
<body>
  <h1>予約ウィジェット（テスト用フィクスチャ）</h1>

  <!-- コンテナ検出用 -->
  <div class="card" data-test="widget-container" data-test-widget-loaded="true">
    <!-- 日付選択 -->
    <div class="row">
      <div class="muted">日付</div>
      <div>
        <button data-test="date-picker" aria-expanded="false">日付を選択</button>
        <div id="calendar" class="grid hidden" role="group" aria-label="日付">
          <!-- JS で relative dates を動的生成（1日後 / 90日後 / 91日後=無効） -->
        </div>
      </div>
    </div>

    <!-- 時間帯（テストが指定する '10:00' / '11:00' / '13:00' をそのまま用意） -->
    <div class="row">
      <div class="muted">時間帯</div>
      <div id="slots" class="grid" role="group" aria-label="時間帯">
        <button data-test="slot-10:00" data-test-slot="10:00">10:00</button>
        <button data-test="slot-11:00" data-test-slot="11:00">11:00</button>
        <button data-test="slot-13:00" data-test-slot="13:00">13:00</button>
      </div>
    </div>

    <!-- hasTimeValue() 保険用の hidden -->
    <input type="hidden" id="timeslot-hidden" name="slot" />

    <!-- 人数入力（両方のセレクタで取れるように data-test と data-test-xxx-count を併記） -->
    <div class="row">
      <div class="muted">大人</div>
      <input type="number" min="0" value="1"
             data-test="adult-count" data-test-adult-count />
    </div>
    <div class="row">
      <div class="muted">学生</div>
      <input type="number" min="0" value="0"
             data-test="student-count" data-test-student-count />
    </div>
    <div class="row">
      <div class="muted">小人</div>
      <input type="number" min="0" value="0"
             data-test="child-count" data-test-child-count />
    </div>
    <div class="row">
      <div class="muted">幼児</div>
      <input type="number" min="0" value="0"
             data-test="infant-count" data-test-infant-count />
    </div>

    <!-- 料金表示（属性とテキストの両面で露出） -->
    <div class="row">
      <div class="muted">合計</div>
      <div>
        <span id="amountLabel"
              data-test="amount"
              data-test-amount="0">¥0</span>
      </div>
    </div>

    <!-- お客様情報 -->
    <div class="row">
      <div class="muted">氏名</div>
      <input type="text" value="テスト太郎"
             data-test="customer-name" data-test-customer-name />
    </div>
    <div class="row">
      <div class="muted">メール</div>
      <input type="email" value="test@example.com"
             data-test="customer-email" data-test-customer-email />
    </div>
    <div class="row">
      <div class="muted">電話</div>
      <input type="tel" value="+81901234567"
             data-test="customer-phone" data-test-customer-phone />
    </div>

    <!-- 簡易的な支払い UI（テスト用の疑似挙動） -->
    <div class="card">
      <div class="row">
        <div class="muted">カード番号</div>
        <input type="text" value="4242424242424242"
               data-test="card-number" data-test-card-number />
      </div>
      <div class="row">
        <div class="muted">有効期限</div>
        <input type="text" value="12/25"
               data-test="card-expiry" data-test-card-expiry />
      </div>
      <div class="row">
        <div class="muted">CVC</div>
        <input type="text" value="123"
               data-test="card-cvc" data-test-card-cvc />
      </div>
      <button data-test="pay-button">支払う</button>
      <!-- 失敗/成功フラグ（両系統のセレクタに対応） -->
      <div id="payError" class="err hidden"
           data-test="payment-error" data-test-error-message>
        決済に失敗しました
      </div>
      <div id="payOk" class="ok hidden"
           data-test="booking-confirmed" data-test-reservation-complete>
        ご予約ありがとうございました！
      </div>
    </div>

    <!-- デバッグ表示 -->
    <div class="muted" id="debug"></div>
  </div>

  <script>
    (function () {
      // ===== 日付ユーティリティ（testData.ts と同じ正午固定ロジック） =====
      const startOfToday = () => { const d = new Date(); d.setHours(12,0,0,0); return d; };
      const pad = n => (n < 10 ? `0${n}` : `${n}`);
      const fmt = d => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
      const plus = (base, days) => { const d = new Date(base); d.setDate(d.getDate()+days); return fmt(d); };
      const base = startOfToday();
      const dates = {
        tomorrow: plus(base, 1),
        day90:   plus(base, 90),
        day91:   plus(base, 91),
      };

      // 料金表
      const PRICE = { adult: 3000, student: 1500, child: 1000, infant: 0 };

      // 要素参照
      const el = {
        calendar: document.getElementById('calendar'),
        datePickerBtn: document.querySelector('[data-test="date-picker"]'),
        amount: document.getElementById('amountLabel'),
        slotsGroup: document.getElementById('slots'),
        hidden: document.getElementById('timeslot-hidden'),
        inputs: {
          adult: document.querySelector('[data-test="adult-count"]'),
          student: document.querySelector('[data-test="student-count"]'),
          child: document.querySelector('[data-test="child-count"]'),
          infant: document.querySelector('[data-test="infant-count"]'),
          name: document.querySelector('[data-test="customer-name"]'),
          email: document.querySelector('[data-test="customer-email"]'),
          phone: document.querySelector('[data-test="customer-phone"]'),
          card: {
            number: document.querySelector('[data-test="card-number"]'),
            expiry: document.querySelector('[data-test="card-expiry"]'),
            cvc: document.querySelector('[data-test="card-cvc"]')
          }
        },
        payBtn: document.querySelector('[data-test="pay-button"]'),
        payOk: document.getElementById('payOk'),
        payErr: document.getElementById('payError'),
        debug: document.getElementById('debug')
      };

      let state = {
        date: null,
        slot: null
      };

      // ===== カレンダー DOM を動的生成（selectors: data-test="date-ISO" / data-test-date="ISO"）=====
      const makeDateBtn = (iso, { disabled = false } = {}) => {
        const b = document.createElement('button');
        b.textContent = iso + (disabled ? '（無効）' : '');
        b.setAttribute('data-test', `date-${iso}`);
        b.setAttribute('data-test-date', iso);
        if (disabled) {
          b.setAttribute('data-test-disabled', 'true');
          b.setAttribute('disabled', 'true');
          b.setAttribute('aria-disabled', 'true');
        }
        return b;
      };
      el.calendar.appendChild(makeDateBtn(dates.tomorrow));
      el.calendar.appendChild(makeDateBtn(dates.day90));
      el.calendar.appendChild(makeDateBtn(dates.day91, { disabled: true }));

      // カレンダー表示切替
      el.datePickerBtn.addEventListener('click', () => {
        const nowHidden = el.calendar.classList.toggle('hidden');
        el.datePickerBtn.setAttribute('aria-expanded', String(!nowHidden));
      });

      // 日付クリック（デリゲート）
      el.calendar.addEventListener('click', (e) => {
        const b = e.target.closest('button');
        if (!b) return;
        if (b.getAttribute('data-test-disabled') === 'true') return; // 無効日は選べない

        const d = b.getAttribute('data-test-date') || (b.dataset.test || '').replace('date-', '');
        state.date = d;

        // 日付選択でスロット選択をリセット + hidden もクリア
        if (el.slotsGroup) {
          el.slotsGroup.querySelectorAll('button').forEach(x => {
            x.classList.remove('selected');
            x.removeAttribute('aria-pressed');
            x.removeAttribute('aria-selected');
            x.removeAttribute('data-state');
            x.removeAttribute('data-selected');
          });
        }
        state.slot = null;
        if (el.hidden) {
          el.hidden.value = '';
          el.hidden.setAttribute('value','');
          el.hidden.setAttribute('data-time-value','');
          el.hidden.setAttribute('data-slot-value','');
        }

        el.calendar.classList.add('hidden');
        el.datePickerBtn.textContent = `選択中: ${d}`;
        render();
      });

      // スロットクリック（親コンテナでデリゲート）
      document.querySelector('[aria-label="時間帯"]').addEventListener('click', (e) => {
        const b = e.target.closest('button');
        if (!b) return;

        const val = b.getAttribute('data-test-slot') || (b.dataset.test || '').replace('slot-', '');
        state.slot = val;

        // ▼ 選択状態を明示（ReservationWidget が拾う全パターン）
        const group = document.querySelector('[aria-label="時間帯"]');
        group.querySelectorAll('button').forEach(x => {
          x.classList.remove('selected');
          x.removeAttribute('aria-pressed');
          x.removeAttribute('aria-selected');
          x.removeAttribute('data-state');
          x.removeAttribute('data-selected');
        });
        b.classList.add('selected');
        b.setAttribute('aria-pressed', 'true');
        b.setAttribute('aria-selected', 'true');
        b.setAttribute('data-state', 'selected');
        b.setAttribute('data-selected', 'true');

        // ▼ hidden 同期（hasTimeValue() 両対応：value属性＋data-*）
        if (el.hidden) {
          el.hidden.value = val;                          // プロパティ
          el.hidden.setAttribute('value', val);           // 属性
          el.hidden.setAttribute('data-time-value', val);
          el.hidden.setAttribute('data-slot-value', val);
        }

        render();
      });

      // 入力イベントで合計更新
      ['adult','student','child','infant'].forEach(k => {
        el.inputs[k].addEventListener('input', render);
      });

      // 決済ボタン
      el.payBtn.addEventListener('click', () => {
        el.payOk.classList.add('hidden');
        el.payErr.classList.add('hidden');

        // 疑似決済：この番号なら失敗
        const decline = '4000000000000002';
        const num = (el.inputs.card.number.value || '').replace(/\s+/g, '');
        if (num === decline) {
          el.payErr.classList.remove('hidden');
          return;
        }
        // 成功
        el.payOk.classList.remove('hidden');
      });

      function calcAmount() {
        const n = {
          adult: +el.inputs.adult.value || 0,
          student: +el.inputs.student.value || 0,
          child: +el.inputs.child.value || 0,
          infant: +el.inputs.infant.value || 0
        };
        return n.adult*PRICE.adult + n.student*PRICE.student + n.child*PRICE.child + n.infant*PRICE.infant;
      }

      function render() {
        const amt = calcAmount();
        el.amount.dataset.testAmount = String(amt);
        el.amount.textContent = '¥' + amt.toLocaleString('ja-JP');

        el.debug.textContent =
          `date=${state.date || '-'} / slot=${state.slot || '-'} / amount=${amt}`;
      }

      render();
    })();
  </script>
</body>
</html>
